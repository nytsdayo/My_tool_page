name: Update README on Page Changes

on:
  push:
    branches: ["main"]
    paths:
      - '**.html'
      - '!README.md'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for HTML changes
        id: check_changes
        run: |
          # Get the list of changed HTML files in the last commit
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.html$' || true)
          echo "Changed HTML files:"
          echo "$CHANGED_FILES"
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Extract page information
        id: extract_info
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Find all HTML files (excluding templates and fragments)
          echo "Extracting information from HTML files..."
          
          # Create a JSON structure with page information
          echo '{"pages":[' > pages_info.json
          first=true
          
          for html_file in $(find . -name "*.html" -not -path "./.git/*" | sort); do
            # Extract title
            title=$(grep -oP '<title>\K[^<]+' "$html_file" 2>/dev/null || echo "")
            
            # Extract description from meta tag or first h1
            description=$(grep -oP '<meta name="description" content="\K[^"]+' "$html_file" 2>/dev/null || \
                         grep -oP '<h1[^>]*>\K[^<]+' "$html_file" 2>/dev/null | head -1 || \
                         grep -oP '<p class="description">\K[^<]+' "$html_file" 2>/dev/null | head -1 || \
                         grep -oP '<p class="tool-description">\K[^<]+' "$html_file" 2>/dev/null | head -1 || \
                         echo "")
            
            # Get icon if exists
            icon=$(grep -oP '<span class="tool-icon">\K[^<]+' "$html_file" 2>/dev/null | head -1 || echo "")
            
            # Skip if no title found
            if [ -n "$title" ]; then
              if [ "$first" = false ]; then
                echo "," >> pages_info.json
              fi
              first=false
              
              # Create JSON object
              jq -n \
                --arg path "$html_file" \
                --arg title "$title" \
                --arg description "$description" \
                --arg icon "$icon" \
                '{path: $path, title: $title, description: $description, icon: $icon}' >> pages_info.json
            fi
          done
          
          echo ']}' >> pages_info.json
          
          echo "Pages information extracted:"
          cat pages_info.json
          
          # Set output flag
          echo "info_extracted=true" >> $GITHUB_OUTPUT

      - name: Generate README with GitHub Copilot
        if: steps.extract_info.outputs.info_extracted == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read the extracted page information
            const pagesInfo = JSON.parse(fs.readFileSync('pages_info.json', 'utf8'));
            
            // Generate README content
            let readme = `# My Tool Page

ä¾¿åˆ©ãªã‚¦ã‚§ãƒ–ãƒ„ãƒ¼ãƒ«ã‚’é›†ã‚ãŸãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã§ã™ã€‚

## ãƒ„ãƒ¼ãƒ«ä¸€è¦§

`;
            
            // Group pages by directory
            const pagesByDir = {};
            pagesInfo.pages.forEach(page => {
              const pathParts = page.path.split('/');
              let category = 'root';
              
              if (pathParts.length > 2) {
                category = pathParts[1];
              } else if (pathParts[1] === 'index.html') {
                return; // Skip root index.html
              }
              
              if (!pagesByDir[category]) {
                pagesByDir[category] = [];
              }
              pagesByDir[category].push(page);
            });
            
            // Add voice-input tools
            if (pagesByDir['voice-input']) {
              pagesByDir['voice-input'].forEach(page => {
                const icon = page.icon || 'ğŸ”§';
                const fileName = page.path.split('/').pop();
                
                if (fileName === 'index.html') {
                  readme += `### ${icon} éŸ³å£°å…¥åŠ›ãƒšãƒ¼ã‚¸\n`;
                  readme += `éŸ³å£°å…¥åŠ›ãŒã§ãã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªWebãƒšãƒ¼ã‚¸ã§ã™ã€‚\n\n`;
                } else if (fileName === 'text-cleaner.html') {
                  readme += `### ğŸ§¹ ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒŠãƒ¼\n`;
                  readme += `éŸ³å£°èªè­˜çµæœã‹ã‚‰ã‚«ã‚¿ã‚«ãƒŠã®ãƒ«ãƒ“ã€åŒºåˆ‡ã‚Šæ–‡å­—ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é™¤å»ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚\n\n`;
                }
              });
            }
            
            // Add 42 tools
            if (pagesByDir['42']) {
              pagesByDir['42'].forEach(page => {
                const icon = page.icon || 'ğŸ“š';
                const dirName = page.path.split('/')[2];
                
                if (dirName === 'ft_review_templete') {
                  readme += `### ğŸ“ 42ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ\n`;
                  readme += `42ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æä¾›ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã€‚\n\n`;
                } else if (dirName === 'minilibX_Japanese_Manual') {
                  readme += `### ğŸ“š minilibXæ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«\n`;
                  readme += `minilibXã®æ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰é›†ã€‚\n\n`;
                }
              });
            }
            
            readme += `## GitHub Pages

ã“ã®ã‚µã‚¤ãƒˆã¯GitHub Pagesã§ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Pages ã«ç§»å‹•
2. Source ã§ "GitHub Actions" ã‚’é¸æŠ
3. main ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™

### ä½¿ã„æ–¹

#### éŸ³å£°å…¥åŠ›ãƒšãƒ¼ã‚¸
1. è¨€èªã‚’é¸æŠï¼ˆæ—¥æœ¬èªã€English (US)ã€English (UK)ï¼‰
2. ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹
3. é¸æŠã—ãŸè¨€èªã§è©±ã™ã¨ã€éŸ³å£°ãŒæ–‡å­—ã«å¤‰æ›ã•ã‚Œã¾ã™
4. ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨åœæ­¢ã—ã¾ã™

### å¯¾å¿œè¨€èª

- æ—¥æœ¬èª (Japanese)
- English (US) - ã‚¢ãƒ¡ãƒªã‚«è‹±èª
- English (UK) - ã‚¤ã‚®ãƒªã‚¹è‹±èª

### å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶

- Google Chrome (æ¨å¥¨)
- Microsoft Edge
- Safari (iOS)

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

\`\`\`
/
â”œâ”€â”€ index.html              # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ï¼‰
â”œâ”€â”€ styles.css              # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«
â”œâ”€â”€ voice-input/
â”‚   â”œâ”€â”€ index.html          # éŸ³å£°å…¥åŠ›ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ style.css           # éŸ³å£°å…¥åŠ›ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”œâ”€â”€ text-cleaner.html   # ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒŠãƒ¼
â”‚   â””â”€â”€ text-cleaner.css    # ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒ¼ãƒŠãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
â”œâ”€â”€ 42/
â”‚   â”œâ”€â”€ ft_review_templete/
â”‚   â”‚   â””â”€â”€ index.html      # 42ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â””â”€â”€ minilibX_Japanese_Manual/
â”‚       â””â”€â”€ index.html      # minilibXæ—¥æœ¬èªãƒãƒ‹ãƒ¥ã‚¢ãƒ«
â””â”€â”€ README.md
\`\`\`
`;
            
            // Write the new README
            fs.writeFileSync('README.md', readme);
            
            console.log('README.md has been updated successfully!');

      - name: Commit and push changes
        if: steps.extract_info.outputs.info_extracted == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if README.md has changes
          if git diff --quiet README.md; then
            echo "No changes to README.md"
            exit 0
          fi
          
          git add README.md
          git commit -m "docs: è‡ªå‹•æ›´æ–° - README.mdã‚’ãƒšãƒ¼ã‚¸å†…å®¹ã«åŸºã¥ã„ã¦æ›´æ–°"
          git push
