<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Structured Canvas (Vanilla JS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f9fafb;
    }

#toolbar {
  position: fixed;
  top: 8px;
  left: 8px;
  z-index: 10;
  background: #ffffff;
  padding: 8px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  gap: 6px;
}

#canvas {
  position: relative;
  width: 100vw;
  height: 100vh;
  cursor: grab;
}
#canvas:active {
  cursor: grabbing;
}

.card {
  position: absolute;
  border: 3px solid #3b82f6;
  border-radius: 14px;
  background: #dbeafe;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  box-sizing: border-box;
}

.card textarea {
  width: 100%;
  height: 100%;
  border: none;
  background: rgba(255,255,255,0.6);
  resize: none;
  outline: none;
  font-size: 14px;
  text-align: center;
  line-height: 1.4;
  border-radius: 10px;
  box-sizing: border-box;
  padding: 6px;
}

button {
  padding: 4px 8px;
  border-radius: 6px;
  border: none;
  background: #e5e7eb;
  cursor: pointer;
}

button:hover {
  background: #d1d5db;
}

  </style>
</head>
<body>

  <div id="toolbar">
    <button id="add-card">カード追加</button>
    <button id="zoom-in">＋</button>
    <button id="zoom-out">－</button>
    <button id="reset-zoom">100%</button>
  </div>

  <div id="canvas"></div>

  <script>
    const canvas = document.getElementById("canvas");

    const state = {
      zoom: 1,
      pan: { x: 0, y: 0 },
      isPanning: false,
      panStart: { x: 0, y: 0 },
      tree: {
        cards: [
          { id: 1, x: 400, y: 120, w: 220, h: 120, text: "" }
        ],
        connections: [],
        nextId: 2
      }
    };

    function addCard(parentId = null) {
      const data = state.tree;
      const id = data.nextId++;

      let x = 300 + Math.random() * 200;
      let y = 100;

      if (parentId) {
        const parent = data.cards.find(c => c.id === parentId);
        y = parent.y + 180;
        data.connections.push({ from: parentId, to: id });
      }

      data.cards.push({ id, x, y, w: 220, h: 120, text: "" });
      render();
    }

    function render() {
      canvas.innerHTML = "";

      state.tree.cards.forEach(card => {
        const el = document.createElement("div");
        el.className = "card";
        el.style.left = card.x * state.zoom + state.pan.x + "px";
        el.style.top = card.y * state.zoom + state.pan.y + "px";
        el.style.width = card.w * state.zoom + "px";
        el.style.height = card.h * state.zoom + "px";

        let dragging = false;
        let dragStart = { x: 0, y: 0 };

        const ta = document.createElement("textarea");
        ta.value = card.text;

        ta.addEventListener("input", e => {
          card.text = e.target.value;
        });

        ta.addEventListener("mousedown", e => {
          dragging = true;
          dragStart = {
            x: e.clientX - card.x,
            y: e.clientY - card.y
          };
          e.preventDefault();
        });

        window.addEventListener("mousemove", e => {
          if (!dragging) return;
          card.x = e.clientX - dragStart.x;
          card.y = e.clientY - dragStart.y;
          render();
        });

        window.addEventListener("mouseup", () => {
          dragging = false;
        });

        el.appendChild(ta);
        canvas.appendChild(el);
      });
      };

    document.getElementById("add-card").addEventListener("click", () => addCard());
    document.getElementById("zoom-in").addEventListener("click", () => {
      state.zoom = Math.min(state.zoom + 0.2, 3);
      render();
    });
    document.getElementById("zoom-out").addEventListener("click", () => {
      state.zoom = Math.max(state.zoom - 0.2, 0.3);
      render();
    });
    document.getElementById("reset-zoom").addEventListener("click", () => {
      state.zoom = 1;
      state.pan = { x: 0, y: 0 };
      render();
    });

    canvas.addEventListener("mousedown", e => {
      state.isPanning = true;
      state.panStart = { x: e.clientX - state.pan.x, y: e.clientY - state.pan.y };
    });

    window.addEventListener("mousemove", e => {
      if (!state.isPanning) return;
      state.pan.x = e.clientX - state.panStart.x;
      state.pan.y = e.clientY - state.panStart.y;
      render();
    });

    window.addEventListener("mouseup", () => {
      state.isPanning = false;
    });

    render();
  </script>

</body>
</html>
